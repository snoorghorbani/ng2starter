!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@ngrx/store"),require("rxjs"),require("@soushians/config"),require("@angular/common/http"),require("@angular/material"),require("rxjs/operators"),require("@angular/material/snack-bar"),require("@angular/router"),require("rxjs/add/operator/do"),require("rxjs/Observable"),require("@ngrx/effects"),require("rxjs/add/operator/map"),require("rxjs/add/operator/mergeMap"),require("@angular/common"),require("@angular/flex-layout"),require("@angular/platform-browser/animations"),require("@angular/forms"),require("@soushians/form")):"function"==typeof define&&define.amd?define("@soushians/authentication",["exports","@angular/core","@ngrx/store","rxjs","@soushians/config","@angular/common/http","@angular/material","rxjs/operators","@angular/material/snack-bar","@angular/router","rxjs/add/operator/do","rxjs/Observable","@ngrx/effects","rxjs/add/operator/map","rxjs/add/operator/mergeMap","@angular/common","@angular/flex-layout","@angular/platform-browser/animations","@angular/forms","@soushians/form"],e):e((t.soushians=t.soushians||{},t.soushians.authentication={}),t.ng.core,null,t.rxjs,null,t.ng.common.http,t.ng.material,t.rxjs.operators,t.ng.material["snack-bar"],t.ng.router,t.rxjs["add/operator/do"],t.rxjs.Observable,null,t.rxjs["add/operator/map"],t.rxjs["add/operator/mergeMap"],t.ng.common,t.ng["flex-layout"],t.ng.platformBrowser.animations,t.ng.forms,null)}(this,function(t,n,e,a,r,o,i,c,s,u,p,f,d,l,g,h,I,y,m,S){"use strict";var v,j=function(e){var n=this;this.Roles=[],e&&Object.keys(e).forEach(function(t){t in e&&(n[t]=e[t])})};!function(t){var e=function(){};t.Request=e;var n=function(){};t.Response=n}(v||(v={}));var b=function(){this.type="[AUTHENTICATION] PROGRESSING_STARTED"},N=function(){this.type="[AUTHENTICATION] PROGRESSING_FINISHED"},E=function(){this.type="[captcha] new captcha"},T={WHO_AM_I:"[AUTHENTICATION] who am i",SIGNIN:"[AUTHENTICATION] Signin",DO_SIGNOUT:"[AUTHENTICATION] Do Signout",SIGNOUT:"[AUTHENTICATION] Signout",SIGNIN_SUCCEED:"[AUTHENTICATION][Signin] Success",SIGNIN_FAILURE:"[AUTHENTICATION][Signin] Failure",SIGNIN_REDIRECT:"[AUTHENTICATION][Signin] Redirect",SIGNIN_REQUIRED:"[AUTHENTICATION][Signin] Required"},M=function(){this.type=T.WHO_AM_I},O=function(t){this.payload=t,this.type=T.SIGNIN},R=function(t){this.payload=t,this.type=T.SIGNIN_SUCCEED},A=function(t){this.payload=t,this.type=T.SIGNIN_FAILURE},w=function(){this.type=T.DO_SIGNOUT},$=function(){this.type=T.SIGNOUT},x=function(){this.type=T.SIGNIN_REQUIRED},C={endpoints:{signOut:"",signIn:"",whoAmI:""},forms:{signIn:""},env:{production:!1},afterSignoutRedirectTo:"/"},_=new n.InjectionToken("ModuleConfig"),U=function(){function t(t,e){var n=this;this.store=e,this.config$=new a.BehaviorSubject(this._config),this._config=Object.assign({},C,t),this.config$.next(this._config),this.store.select(r.getAuthenticationModuleConfig).subscribe(function(t){t&&(n._config=Object.assign({},n._config,t.Config),n.config$.next(n._config))})}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:n.Inject,args:[_]}]},{type:e.Store}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(_),n.inject(e.Store))},token:t,providedIn:"root"}),t}(),P=function(){function t(t,e,n,r){var o=this;this.http=t,this.store=e,this.configurationService=n,this.snackBar=r,setTimeout(function(){return o.store.dispatch(new M)},300)}return t.prototype.signin=function(e){var n=this;return this.configurationService.config$.pipe(c.filter(function(t){return""!=t.endpoints.signIn}),c.take(1),c.switchMap(function(t){return n.http.post(t.endpoints.signIn,e)}),c.map(function(t){var e=Object.assign({},t.Result);return e.Role&&(e.Roles=[e.Role]),e}))},t.prototype.signout=function(){return this.http.get(this.configurationService.config.endpoints.signOut).map(function(t){return t})},t.prototype.whoAmI=function(){return this.http.get(this.configurationService.config.endpoints.whoAmI).map(function(t){return t})},t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:o.HttpClient},{type:e.Store},{type:U},{type:i.MatSnackBar}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(o.HttpClient),n.inject(e.Store),n.inject(U),n.inject(s.MatSnackBar))},token:t,providedIn:"root"}),t}(),D=function(){function t(t,e){this.configurationService=t,this.store=e,this.signedIn$=new n.EventEmitter,this.formId$=this.configurationService.config$.map(function(t){return t.forms.signIn})}return t.prototype.signIn=function(t){this.store.dispatch(new O(t)),this.signedIn$.emit(!0)},t.decorators=[{type:n.Component,args:[{template:"\n        <auth-signin \n                [formId]='(formId$ | async)'\n                (signedin)=\"signIn($event)\"\n        ></auth-signin>\n  "}]}],t.ctorParameters=function(){return[{type:U},{type:e.Store}]},t.propDecorators={signedIn$:[{type:n.Output}]},t}(),G=function(){return(G=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function k(t,e,n,r){var o,i=arguments.length,a=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var c=t.length-1;0<=c;c--)(o=t[c])&&(a=(i<3?o(a):3<i?o(e,n,a):o(e,n))||a);return 3<i&&a&&Object.defineProperty(e,n,a),a}function q(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var F={loggedIn:!1,user:new j({Id:1})};function H(t,e){switch(void 0===t&&(t=F),e.type){case T.SIGNIN_SUCCEED:return G({},t,{loggedIn:!0,user:e.payload});case T.SIGNOUT:return G({},t,{loggedIn:!1,user:new j});default:return t}}var B={userStatus:H},L=e.createFeatureSelector("authentication"),Q=e.createSelector(L,function(t){return t.userStatus}),W=e.createSelector(Q,function(t){return t.loggedIn}),V=e.createSelector(Q,function(t){return t.user}),z=(function(){function t(t){this.store=t}t.prototype.canActivate=function(t,e){return this.store.select(V).take(1).map(function(t){return t.Roles.includes("Admin")})},t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.Store}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(e.Store))},token:t,providedIn:"root"})}(),function(){function t(t){this.store=t}t.prototype.canActivate=function(t,e){return this.store.select(V).take(1).map(function(t){return t.Roles.includes("Agent")})},t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.Store}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(e.Store))},token:t,providedIn:"root"})}(),function(){function t(t){this.store=t}t.prototype.canActivate=function(t,e){return this.store.select(V).take(1).map(function(t){return t.Roles.includes("User")})},t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.Store}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(e.Store))},token:t,providedIn:"root"})}(),function(){function t(t){this.store=t}return t.prototype.canActivate=function(t,e){return this.store.select(W).take(1).map(function(t){return!t})},t.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:e.Store}]},t.ngInjectableDef=n.defineInjectable({factory:function(){return new t(n.inject(e.Store))},token:t,providedIn:"root"}),t}()),J=function(){function t(){}return t.decorators=[{type:n.Component,args:[{template:"\n          <router-outlet></router-outlet>\n        "}]}],t}(),K=[{path:"auth",component:J,children:[{path:"signin",canActivate:[z],component:D}]}],X=u.RouterModule.forChild(K),Y=function(){function t(){this.signedin=new n.EventEmitter}return t.prototype.signin=function(t){t.valid&&this.signedin.emit(t.value)},t.decorators=[{type:n.Component,args:[{selector:"auth-signin",template:'<div fxLayout=\'row\' fxLayoutAlign="center center">\n    <ngs-form-view \n        [id]="formId"\n        [card]="true"\n        (accept)="signin($event)"\n    ></ngs-form-view>\n</div>\n\x3c!-- <div>\n    <a fxFlex="nogrow" routerLink="/user/password/reset" mat-raised-button fxFlexFill>کلمه عبور خود را فراموش کرده اید؟</a>\n</div> --\x3e',styles:[""]}]}],t.ctorParameters=function(){return[]},t.propDecorators={signedin:[{type:n.Output}],formId:[{type:n.Input}]},t}(),Z=function(){function t(t){this.configurationService=t}return t.prototype.intercept=function(t,e){return t.withCredentials=!0,e.handle(t)},t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:U}]},t}(),tt=function(){function t(t,e){this.router=t,this.store=e}return t.prototype.intercept=function(t,e){var n=this;return e.handle(t).map(function(t){if(t instanceof o.HttpResponse)return t})["catch"](function(t){return t instanceof o.HttpErrorResponse?401!=t.status?a.throwError(t):t.url.includes("logout")?a.throwError(t):t.url.includes("user/account/profile")?a.throwError(t):(n.store.dispatch(new $),a.throwError("Unauthorized")):a.throwError(t)})},t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:u.Router},{type:e.Store}]},t}(),et=function(){function t(t,e,n,r,o){var i=this;this.actions$=t,this.router=e,this.signinService=n,this.configurationService=r,this.bottomSheet=o,this.whoAmI$=this.actions$.ofType(T.WHO_AM_I).pipe(c.switchMap(function(){return i.signinService.whoAmI()}),c.map(function(t){return new R(t)}),c.catchError(function(t){return f.Observable.of(new A(t))})),this.Signin$=this.actions$.ofType(T.SIGNIN).pipe(c.pluck("payload"),c.switchMap(function(t){return i.signinService.signin(t)}),c.map(function(t){return new R(t)}),c.catchError(function(t){return f.Observable.of(new A(t))})),this.SignInRequired$=this.actions$.ofType(T.SIGNIN_REQUIRED).pipe(c.tap(function(t){var e=i.bottomSheet.open(D,{panelClass:"clear-mat-card-box"});return e.instance.signedIn$.subscribe(function(){e.dismiss()}),e})),this.SigninSucceed$=this.actions$.ofType(T.SIGNIN_SUCCEED).pipe(c.tap(function(t){-1<location.pathname.indexOf("signin")&&i.router.navigate(["/"])})),this.AfterSigninFiled$=this.actions$.ofType(T.SIGNIN_FAILURE).map(function(){return new E}),this.DoSignout$=this.actions$.ofType(T.DO_SIGNOUT).pipe(c.switchMap(function(t){return i.signinService.signout().pipe(c.map(function(){return new $}),c.catchError(function(t){return a.of(t)}))})),this.redirectToLoginPage$=this.actions$.ofType(T.SIGNIN_REDIRECT).pipe(c.tap(function(t){return i.router.navigate(["auth/signin"])})),this.redirectAfterSignout$=this.actions$.ofType(T.SIGNOUT).pipe(c.tap(function(t){return i.router.navigate([i.configurationService.config$.getValue().afterSignoutRedirectTo])}))}return t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:d.Actions},{type:u.Router},{type:P},{type:U},{type:i.MatBottomSheet}]},k([d.Effect(),q("design:type",Object)],t.prototype,"whoAmI$",void 0),k([d.Effect(),q("design:type",Object)],t.prototype,"Signin$",void 0),k([d.Effect({dispatch:!1}),q("design:type",Object)],t.prototype,"SignInRequired$",void 0),k([d.Effect({dispatch:!1}),q("design:type",Object)],t.prototype,"SigninSucceed$",void 0),k([d.Effect(),q("design:type",Object)],t.prototype,"AfterSigninFiled$",void 0),k([d.Effect(),q("design:type",Object)],t.prototype,"DoSignout$",void 0),k([d.Effect({dispatch:!1}),q("design:type",Object)],t.prototype,"redirectToLoginPage$",void 0),k([d.Effect({dispatch:!1}),q("design:type",Object)],t.prototype,"redirectAfterSignout$",void 0),t}(),nt=function(){function t(t,e){this.actions$=t,this.router=e,this.dispachProgressingStarted$=this.actions$.ofType(T.SIGNIN).pipe(c.map(function(){return new b})),this.dispachProgressingFinished$=this.actions$.ofType(T.SIGNIN_FAILURE,T.SIGNIN_SUCCEED).pipe(c.map(function(){return new N}))}return t.decorators=[{type:n.Injectable}],t.ctorParameters=function(){return[{type:d.Actions},{type:u.Router}]},k([d.Effect(),q("design:type",Object)],t.prototype,"dispachProgressingStarted$",void 0),k([d.Effect(),q("design:type",Object)],t.prototype,"dispachProgressingFinished$",void 0),t}(),rt=function(){function t(){}return t.forRoot=function(t){return void 0===t&&(t={}),{ngModule:ot,providers:[{provide:_,useValue:t},{provide:o.HTTP_INTERCEPTORS,useClass:tt,multi:!0},{provide:o.HTTP_INTERCEPTORS,useClass:Z,multi:!0},P]}},t.decorators=[{type:n.NgModule,args:[{imports:[h.CommonModule,u.RouterModule,m.FormsModule,o.HttpClientModule,I.FlexLayoutModule,i.MatIconModule,i.MatButtonModule,i.MatCardModule,i.MatSnackBarModule,i.MatSidenavModule,i.MatExpansionModule,i.MatSelectModule,i.MatBottomSheetModule,i.MatFormFieldModule,i.MatListModule,i.MatMenuModule,i.MatRadioModule,i.MatInputModule,i.MatToolbarModule,i.MatDatepickerModule,i.MatProgressBarModule,y.BrowserAnimationsModule,m.ReactiveFormsModule,m.FormsModule,S.NgsFormModule],declarations:[D,Y,J],entryComponents:[D],providers:[],exports:[]}]}],t}(),ot=function(){function t(){}return t.decorators=[{type:n.NgModule,args:[{imports:[e.StoreModule.forFeature("authentication",B),d.EffectsModule.forFeature([et,nt]),X,rt]}]}],t}();t.UserModel=j,t.SignInActionTypes=T,t.DoSignoutAction=w,t.SigninRequiredAction=x,t.SigninService=P,t.SigninContainerComponent=D,t.NgsAuthenticationModule=rt,t.ɵl=X,t.ɵd=_,t.ɵa=ot,t.ɵf=Y,t.ɵk=nt,t.ɵj=et,t.ɵn=tt,t.ɵo=Z,t.ɵh=B,t.ɵi=H,t.ɵm=z,t.ɵc=U,t.ɵg=J,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=soushians-authentication.umd.min.js.map