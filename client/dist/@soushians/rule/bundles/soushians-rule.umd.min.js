!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("@ngrx/store"),require("rxjs/BehaviorSubject"),require("@angular/common/http"),require("rxjs/Rx"),require("rxjs/operators"),require("@soushians/shared"),require("rxjs"),require("@angular/material"),require("@angular/forms"),require("@ngrx/effects"),require("@soushians/frontend-authentication"),require("@angular/common"),require("@angular/flex-layout"),require("@angular/platform-browser/animations")):"function"==typeof define&&define.amd?define("@soushians/rule",["exports","@angular/core","@angular/router","@ngrx/store","rxjs/BehaviorSubject","@angular/common/http","rxjs/Rx","rxjs/operators","@soushians/shared","rxjs","@angular/material","@angular/forms","@ngrx/effects","@soushians/frontend-authentication","@angular/common","@angular/flex-layout","@angular/platform-browser/animations"],e):e((t.soushians=t.soushians||{},t.soushians.rule={}),t.ng.core,t.ng.router,null,t.rxjs.BehaviorSubject,t.ng.common.http,t.rxjs.Rx,t.rxjs.operators,null,t.rxjs,t.ng.material,t.ng.forms,null,null,t.ng.common,t.ng["flex-layout"],t.ng.platformBrowser.animations)}(this,function(t,e,n,o,r,i,a,s,c,u,p,f,d,l,h,m,y){"use strict";var v={endpoints:{upsert:"/api/gwt/scenario",get:"/api/gwt/anchor/${model.anchorId}/scenarios"},stepClasses:[],env:{production:!1,frontend_server:"http://localhost:3000"}},g=new e.InjectionToken("RuleModuleConfig"),b=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:e.Component,args:[{selector:"app-rule",template:'<div fxLayout="row" fxLayoutAlign="center center">\n  <router-outlet></router-outlet>\n</div>'}]}],t.ctorParameters=function(){return[]},t}(),_=[{path:"rule",component:b}],x=n.RouterModule.forChild(_),S=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t};function I(t,e,n,o){var r,i=arguments.length,a=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,o);else for(var s=t.length-1;0<=s;s--)(r=t[s])&&(a=(i<3?r(a):3<i?r(e,n,a):r(e,n))||a);return 3<i&&a&&Object.defineProperty(e,n,a),a}function E(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var w="[RULE][ANCHORS] SHOW_ANCHORS",R="[RULE][ANCHORS] HIDE_ANCHORS",L=function(){this.type=w},M=function(){this.type=R},C={active:!1};function j(t,e){switch(void 0===t&&(t=C),e.type){case w:return S({},t,{active:!0});case R:return S({},t,{active:!1});default:return t}}var A="[RULE][DB] RULES_LIST",O="[RULE][DB] RULES_LIST_START",F="[RULE][DB] RULES_LIST_SUCCEED",$="[RULE][DB] RULES_LIST_FAILED",T="[RULE][DB] RULE_UPSERT",D="[RULE][DB] RULE_FETCHED",B=function(){this.type=O},P={status:"pristine",data:[]};function U(t,e){switch(void 0===t&&(t=P),e.type){case A:return S({},t,{status:"dirty"});case O:return S({},t,{status:"pending"});case F:return S({},t,{data:e.payload,status:"succeed"});case $:return S({},t,{status:"failed"});case T:var n=t.data.concat();return-1<(o=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[o]=Object.assign({},n[o],e.payload):n.push(e.payload),S({},t,{data:n});case D:var o;n=t.data.concat();return-1<(o=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[o]=Object.assign({},n[o],e.payload):n.push(e.payload),S({},t,{data:n});default:return t}}var k="[GWT][SCENARIO][DB][LIST] SCENARIOS_LIST",N="[SCENARIO][DB] SCENARIOS_LIST_START",q="[SCENARIO][DB] SCENARIOS_LIST_SUCCEED",G="[SCENARIO][DB] SCENARIOS_LIST_FAILED",H="[GWT][SCENARIO][DB][UPSERT] SCENARIO_UPSERT",V="[SCENARIO][DB] SCENARIO_FETCHED",W="[GWT][SCENARIO][DB] UPDATE_DB",z=function(){this.type=N},K=function(t){this.payload=t,this.type=H},J=function(t){this.payload=t,this.type=V},Q={status:"pristine",data:[]};function X(n,e){switch(void 0===n&&(n=Q),e.type){case k:return S({},n,{status:"dirty"});case N:return S({},n,{status:"pending"});case q:return S({},n,{data:e.payload,status:"succeed"});case G:return S({},n,{status:"failed"});case H:var t=n.data.concat();return-1<(o=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[o]=Object.assign({},t[o],e.payload):t.push(e.payload),S({},n,{data:t});case V:var o;t=n.data.concat();return-1<(o=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[o]=Object.assign({},t[o],e.payload):t.push(e.payload),S({},n,{data:t});case W:var r=n.data.concat();return e.payload.forEach(function(e){var t=n.data.findIndex(function(t){return t._id==e._id});-1<t?r[t]=Object.assign({},r[t],e):r.push(e)}),S({},n,{data:r});default:return n}}var Y={ruleAnchors:j,rules:U,scenarios:X},Z=function(){function t(t,e,n){var o=this;this.store=e,this.injector=n,this.config$=new r.BehaviorSubject(v),t.steps=t.stepClasses.map(function(t){return new t(o.injector)}),this._config=Object.assign({},v,t),this.config$.next(this._config)}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:e.Inject,args:[g]}]},{type:o.Store},{type:e.Injector}]},t}(),tt=function(){function t(t){var e=void 0===t?{}:t,n=e._id,o=e.anchorId,r=e.steps,i=e.name,a=e.featureId;this._id=n||"",this.name=i||"",this.featureId=a||"",this._id=n||"",this.anchorId=o||"",this.steps=r||[]}return t.prototype.getRequsetBody=function(){return{_id:this._id,anchorId:this.anchorId,name:this.name,featureId:this.featureId,steps:this.steps.map(function(t){return{id:t.id,opposite:t.opposite,params:t.params}})}},t}(),et=function(){function t(t,e){this.resolver=t,this.container=e}return Object.defineProperty(t.prototype,"params",{get:function(){return this.component.instance.params||{}},enumerable:!0,configurable:!0}),t.prototype.ngOnChanges=function(){this.component},t.prototype.ngOnInit=function(){if(!this.step.stepComponent)throw new Error("Trying to use an unsupported type ().\n\t\t  Supported types: ");var t=this.resolver.resolveComponentFactory(this.step.stepComponent);this.component=this.container.createComponent(t),this.component.instance.params=this.step.params},t.decorators=[{type:e.Directive,args:[{selector:"[rule-step-loader]"}]}],t.ctorParameters=function(){return[{type:e.ComponentFactoryResolver},{type:e.ViewContainerRef}]},t.propDecorators={step:[{type:e.Input}],component:[{type:e.ViewChild,args:["container",{read:e.ViewContainerRef}]}]},t}(),nt=function(){function t(t,e,n){var o=this;this.http=t,this.store=e,this.configService=n,this.config$=this.configService.config$,this.config$.subscribe(function(t){return o.config=t})}return t.prototype.upsert=function(t){var e=new tt(t);return this.http.post(""+this.config.env.frontend_server+this.config.endpoints.upsert,e.getRequsetBody()).pipe(s.map(function(t){return t}),s.share())},t.prototype.getAnchorScenarios=function(t){return this.http.get(""+this.config.env.frontend_server+c.stringTemplate(this.config.endpoints.get,{anchorId:t})).map(function(t){return t.Result})},t.prototype.selectScenarioById=function(e){var n=new a.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(s.filter(function(t){return null!=t}),s.map(function(t){return t.find(function(t){return t._id==e})}),s.filter(function(t){return t!=undefined})).subscribe(function(t){n.next(t)}),n.asObservable()},t.prototype.selectAnchorScenarios=function(e){var n=new a.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(s.startWith([]),s.filter(function(t){return null!=t}),s.map(function(t){return t.filter(function(t){return t._id==e})})).subscribe(function(t){n.next(t)}),n.asObservable()},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:i.HttpClient},{type:o.Store},{type:Z}]},t}(),ot=function(){function t(t,e,n,o,r){this.store=t,this.configService=e,this.scenarioService=n,this.injector=o,this.data=r,this.unsubscribe=new u.Subject,this.scenario$=new u.BehaviorSubject(new tt),this.scenarios$=new u.BehaviorSubject([]),this._create_scenario_form_group(),this._init_features_list()}return t.prototype.ngOnInit=function(){var e=this;this.steps$=this.configService.config$.pipe(s.map(function(t){return t.steps}),s.takeUntil(this.unsubscribe)),this.steps$.subscribe(function(t){return e.steps=t}),this._load_scenario_and_map_scenario_step_to_steps_class()},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype.save=function(){var t=this.scenario$.getValue();this.stepLoaders.forEach(function(e){t.steps.find(function(t){return t.name==e.step.name}).params=e.params}),t.featureId=this.scenarioFormGroup.value.featureId,t.name=this.scenarioFormGroup.value.name,this.store.dispatch(new K(t))},t.prototype.addStepToScenario=function(t){var e=this.scenario$.getValue();e.steps.push(t),this.scenario$.next(e)},t.prototype.deleteStepFromScenario=function(e){var t=this.scenario$.getValue();t.steps.splice(t.steps.findIndex(function(t){return t.name==e.name}),1),this.scenario$.next(t)},t.prototype.decScenarioStepPriority=function(t){},t.prototype.incScenarioStepPriority=function(t){},t.prototype.addNewScenario=function(){var t=this.scenarios$.getValue();t.push(new tt({anchorId:this.data.anchorId})),this.scenarios$.next(t)},t.prototype.activeScenario=function(t){var n=this;t.steps=t.steps.map(function(e){var t=n.steps.find(function(t){return t.id==e.id});return t.params=e.params,t}),this.scenarioFormGroup.patchValue(t),t.anchorId=this.data.anchorId,this.scenario$.next(t)},t.prototype._load_scenario_and_map_scenario_step_to_steps_class=function(){var e=this;this.scenarioService.getAnchorScenarios(this.data.anchorId).pipe(s.takeUntil(this.unsubscribe)).subscribe(function(t){e.scenarios$.next(t),e.activeScenario(t[0]||new tt)})},t.prototype._create_scenario_form_group=function(){this.scenarioFormGroup=new f.FormGroup({featureId:new f.FormControl,name:new f.FormControl})},t.prototype._reset_scenario_form_group_and_patch_with_active_scenario=function(){this.scenarioFormGroup.reset(),this.scenarioFormGroup.patchValue(this.scenario$.getValue())},t.prototype._init_features_list=function(){this.features$=["مدیریت نمایش براساس دسترسی های کاربر"]},t.decorators=[{type:e.Component,args:[{selector:"app-gwt-view",template:'<div fxLayout="row" fxLayoutGap="25px">\n<div fxFlex="400px" fxLayout="column" fxLayoutGap="15px">\n  <div fxLayout="row wrap">\n    <mat-form-field appearance="fill" fxFlex="100">\n      <input matInput placeholder="فیلتر">\n      <mat-icon matSuffix>search</mat-icon>\n    </mat-form-field>\n    <mat-checkbox fxFlex class="example-margin">فرض کنید</mat-checkbox>\n    <mat-checkbox fxFlex class="example-margin">هنگامی که</mat-checkbox>\n    <mat-checkbox fxFlex class="example-margin">آنگاه</mat-checkbox>\n  </div>\n    <mat-card class="steps-item" *ngFor="let step of steps$ | async">\n      <span class="step-text">\n        {{step.description}}\n      </span>\n      <button mat-icon-button class="add-button" (click)="addStepToScenario(step)">\n        <mat-icon>arrow_back_ios</mat-icon>\n      </button>\n    </mat-card>\n</div>\n\n<div fxFlex="700px">\n  <div fxLayout="row wrap" fxLayoutGap="25px" fxLayoutAlign="center center" class="scenario-toolbar">\n    <div fxFlex>\n        <mat-form-field class="fit">\n            <mat-select placeholder="وِیژگی" (selectionChange)="activeScenario($event.value)">\n                  <mat-option *ngFor="let scenario of scenarios$ | async" [value]="scenario">\n                {{ scenario.featureId }} : {{ scenario.name }}\n              </mat-option>\n            </mat-select>\n          </mat-form-field>\n    </div>\n    <button fxFlex="nogrow" mat-raised-button color="primary" (click)="addNewScenario()">\n       ثبت سناریو جدید\n    </button>\n  </div>\n  <div fxLayout="column" fxLayoutGap="15px">\n    <div fxFlex="100" fxLayout="row" fxLayoutGap="25px" [formGroup]="scenarioFormGroup">\n      <mat-form-field fxFlex="50">\n        <mat-select placeholder="ویژگی" formControlName="featureId">\n          <mat-option *ngFor="let feature of features$" [value]="feature">\n            {{ feature }}\n          </mat-option>\n        </mat-select>\n      </mat-form-field>\n      <mat-form-field fxFlex="50">\n        <input matInput placeholder="نام" formControlName="name">\n      </mat-form-field>\n    </div>\n    <ng-container *ngFor="let step of (scenario$ | async).steps">\n      <div class="scenario-steps-item">\n        <ng-container rule-step-loader [step]="step"></ng-container>\n        <div class="scenario-steps-action">\n          <button mat-icon-button (click)="deleteStepFromScenario(step)">\n            <mat-icon>delete</mat-icon>\n          </button>\n          <button mat-icon-button (click)="incScenarioStepPriority(step)">\n            <mat-icon>keyboard_arrow_up</mat-icon>\n          </button>\n          <button mat-icon-button (click)="decScenarioStepPriority(step)">\n            <mat-icon>keyboard_arrow_down</mat-icon>\n          </button>\n        </div>\n      </div>\n    </ng-container>\n      <button fxFlex="nogrow" mat-raised-button color="primary" (click)="save()">\n        ثبت\n      </button>\n    </div>\n  </div>\n</div>',styles:[":host{width:100vw}.scenario-toolbar{height:60px;margin-bottom:20px}"]}]}],t.ctorParameters=function(){return[{type:o.Store},{type:Z},{type:nt},{type:e.Injector},{type:undefined,decorators:[{type:e.Inject,args:[p.MAT_BOTTOM_SHEET_DATA]}]}]},t.propDecorators={stepLoaders:[{type:e.ViewChildren,args:[et]}]},t}(),rt={Given:"Given",When:"When",Then:"Then",And:"And",But:"But"},it=function(){function t(t,e,n,o,r,i){var a=this;this.scenarioService=t,this.configService=e,this.store=n,this.el=o,this.renderer=r,this.bottomSheet=i,this.unsubscribe=new u.Subject,this.active$=this.store.select(function(t){return t.rule.ruleAnchors.active}).pipe(s.takeUntil(this.unsubscribe)),this.active$.subscribe(function(t){return a.active=t}),this.el.nativeElement.classList.add("ngs-rule-anchor"),this.steps=this.configService.config$.getValue().steps}return t.prototype.onMouseEnter=function(){this.active&&this.showAnchor()},t.prototype.onMouseLeave=function(){this.active&&this.hideAnchor()},t.prototype.showAnchor=function(){this.el.nativeElement.classList.add("show-anchor")},t.prototype.hideAnchor=function(){this.el.nativeElement.classList.remove("show-anchor")},t.prototype.ngOnInit=function(){var n=this;this.anchorScenarios$=this.scenarioService.getAnchorScenarios(this.anchorId).pipe(s.takeUntil(this.unsubscribe),s.filter(function(t){return t!=undefined})),this.active$.subscribe(function(t){t?n._activate_anchor():n._deactivate_anchor()}),this.anchorScenarios$.subscribe(function(t){t.forEach(function(t){t.steps=t.steps.map(function(e){var t=n.steps.find(function(t){return t.id==e.id});return t.params=e.params,t}),n._do_scenario(t)})})},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype._activate_anchor=function(){this._create_anchor(),this._set_active_class_to_host()},t.prototype._deactivate_anchor=function(){this._remove_anchor(),this._remove_active_class_to_host()},t.prototype._set_active_class_to_host=function(){this.el.nativeElement.classList.add("anchor-active")},t.prototype._remove_active_class_to_host=function(){this.el.nativeElement.classList.remove("anchor-active")},t.prototype._create_anchor=function(){var e=this;this.button=this.renderer.createElement("button"),this.button.classList.add("ngs-rule-anchor-button","mat-icon-button"),this.button.setAttribute("mat-icon-button",""),this.button.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),e.bottomSheet.open(ot,{data:{anchorId:e.anchorId},panelClass:"magenta-theme"})});var t=this.renderer.createElement("mat-icon");t.classList.add("mat-icon","material-icons");var n=this.renderer.createText("settings");this.renderer.appendChild(t,n),this.renderer.appendChild(this.button,t),this.renderer.appendChild(this.el.nativeElement,this.button)},t.prototype._remove_anchor=function(){this.button&&this.button.parentNode.removeChild(this.button)},t.prototype._do_scenario=function(n){var o=this,t=n.steps.filter(function(t){return t.type==rt.Given}).map(function(t){return t.interperator(t.params)});u.combineLatest(t).pipe(s.takeUntil(this.unsubscribe),s.map(function(t){return t.every(function(t){return!0===t})}),s.switchMap(function(t){if(t){var e=n.steps.filter(function(t){return t.type==rt.Then}).map(function(t){return t.interperator(t.params,o.el)});return u.combineLatest.apply(null,e).pipe(s.map(function(t){return t.every(function(t){return!0===t})}))}return u.of(!1)})).subscribe(function(){})},t.decorators=[{type:e.Directive,args:[{selector:"[ruleAnchor]"}]}],t.ctorParameters=function(){return[{type:nt},{type:Z},{type:o.Store},{type:e.ElementRef},{type:e.Renderer2},{type:p.MatBottomSheet}]},t.propDecorators={anchorId:[{type:e.Input,args:["ruleAnchor"]}],onMouseEnter:[{type:e.HostListener,args:["mouseenter"]}],onMouseLeave:[{type:e.HostListener,args:["mouseleave"]}]},t}(),at=function(){function t(t,e){var n=this;this.actions$=t,this.service=e,this.EditProfileRequest$=this.actions$.ofType(k).pipe(s.map(function(){return new z})),this.UpsertScenario$=this.actions$.ofType(H).pipe(s.map(function(t){return t.payload}),s.switchMap(function(t){return n.service.upsert(t)}),s.map(function(t){return new J(t)}))}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:d.Actions},{type:nt}]},I([d.Effect(),E("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),I([d.Effect(),E("design:type",Object)],t.prototype,"UpsertScenario$",void 0),t}(),st=function(){function t(t){this.actions$=t,this.EditProfileRequest$=this.actions$.ofType(A).map(function(){return new B})}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:d.Actions}]},I([d.Effect(),E("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),t}(),ct=function(){function t(t){this.store=t,this.anchorsMode=!1,this.havePermission$=this.store.select(l.getFrontendAuthenticationState)}return t.prototype.toggleAnchors=function(){!1===this.anchorsMode?(this.store.dispatch(new L),this.anchorsMode=!0):(this.store.dispatch(new M),this.anchorsMode=!1)},t.decorators=[{type:e.Component,args:[{selector:"gwt-mode-button",template:'    <button *ngIf="!(havePermission$ | async)" class="btn" mat-mini-fab type="button" routerLink="auth/frontend/signin" fxFlex="nogrow" fxLayoutAlign="center center">\n      <mat-icon>fingerprint</mat-icon>\n    </button>\n\n    <button *ngIf="havePermission$ | async" class="btn" mat-mini-fab type="button" (click)="toggleAnchors()" fxFlex="nogrow" fxLayoutAlign="center center">\n      <mat-icon>settings</mat-icon>\n    </button>',styles:[".btn{position:fixed;bottom:25px;right:25px;z-index:3}"]}]}],t.ctorParameters=function(){return[{type:o.Store}]},t}(),ut=function(){function t(t,e,n){this.http=t,this.store=e,this.configurationService=n}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:i.HttpClient},{type:o.Store},{type:Z}]},t}(),pt=function(){function t(){}return t.forRoot=function(t){return{ngModule:ft,providers:[{provide:g,useValue:t||{}},ut,Z,nt]}},t.decorators=[{type:e.NgModule,args:[{imports:[i.HttpClientModule,f.FormsModule,n.RouterModule,h.CommonModule,p.MatExpansionModule,p.MatSnackBarModule,p.MatIconModule,p.MatButtonModule,p.MatCardModule,p.MatCheckboxModule,p.MatTableModule,p.MatSelectModule,p.MatInputModule,p.MatFormFieldModule,p.MatTabsModule,p.MatDividerModule,m.FlexLayoutModule,p.MatRadioModule,p.MatSlideToggleModule,f.ReactiveFormsModule,y.BrowserAnimationsModule],declarations:[b,it,ot,et,ct],entryComponents:[ot],exports:[it,ct]}]}],t}(),ft=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[pt,o.StoreModule.forFeature("rule",Y),d.EffectsModule.forFeature([st,at]),x],exports:[pt]}]}],t}();t.GwtStepTypes=rt,t.ShowAnchorsAction=L,t.HideAnchorsAction=M,t.RuleModule=pt,t.RootRuleModule=ft,t.MODULE_DEFAULT_CONFIG=v,t.MODULE_CONFIG_TOKEN=g,t.ɵn=st,t.ɵl=U,t.ɵo=at,t.ɵm=X,t.ɵh=ot,t.ɵj=ct,t.ɵb=it,t.ɵk=j,t.ɵp=x,t.ɵa=b,t.ɵe=Y,t.ɵg=Z,t.ɵq=ut,t.ɵc=nt,t.ɵi=et,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=soushians-rule.umd.min.js.map