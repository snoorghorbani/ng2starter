!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/common"),require("@angular/flex-layout"),require("@angular/platform-browser/animations"),require("@angular/router"),require("rxjs"),require("@angular/material"),require("@angular/forms"),require("rxjs/BehaviorSubject"),require("rxjs/Rx"),require("@soushians/shared"),require("@ngrx/effects"),require("rxjs/operators"),require("@soushians/frontend-authentication"),require("@angular/core"),require("@angular/common/http"),require("@ngrx/store")):"function"==typeof define&&define.amd?define("@soushians/rule",["exports","@angular/common","@angular/flex-layout","@angular/platform-browser/animations","@angular/router","rxjs","@angular/material","@angular/forms","rxjs/BehaviorSubject","rxjs/Rx","@soushians/shared","@ngrx/effects","rxjs/operators","@soushians/frontend-authentication","@angular/core","@angular/common/http","@ngrx/store"],e):e((t.soushians=t.soushians||{},t.soushians.rule={}),t.ng.common,t.ng["flex-layout"],t.ng.platformBrowser.animations,t.ng.router,t.rxjs,t.ng.material,t.ng.forms,t.rxjs.BehaviorSubject,t.rxjs.Rx,t.shared,t.effects,t.rxjs.operators,t.frontendAuthentication,t.ng.core,t.ng.common.http,t.store)}(this,function(t,e,n,r,o,s,i,a,c,u,p,f,d,h,l,m,y){"use strict";var v={endpoints:{upsert:"/api/gwt/scenario",get:"/api/gwt/anchor/${model.anchorId}/scenarios"},stepClasses:[],env:{production:!1,frontend_server:"frontend_server/did/not/set"}},g=new l.InjectionToken("RuleModuleConfig"),b=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:l.Component,args:[{selector:"app-rule",template:'<div fxLayout="row" fxLayoutAlign="center center">\n  <router-outlet></router-outlet>\n</div>'}]}],t.ctorParameters=function(){return[]},t}(),_=[{path:"rule",component:b}],x=o.RouterModule.forChild(_),S=function(){return(S=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function I(t,e,n,r){var o,i=arguments.length,a=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;0<=s;s--)(o=t[s])&&(a=(i<3?o(a):3<i?o(e,n,a):o(e,n))||a);return 3<i&&a&&Object.defineProperty(e,n,a),a}function w(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var E="[RULE][ANCHORS] SHOW_ANCHORS",R="[RULE][ANCHORS] HIDE_ANCHORS",L=function dt(){this.type=E},j=function ht(){this.type=R},C={active:!1};function M(t,e){switch(void 0===t&&(t=C),e.type){case E:return S({},t,{active:!0});case R:return S({},t,{active:!1});default:return t}}var A="[RULE][DB] RULES_LIST",O="[RULE][DB] RULES_LIST_START",$="[RULE][DB] RULES_LIST_SUCCEED",F="[RULE][DB] RULES_LIST_FAILED",T="[RULE][DB] RULE_UPSERT",B="[RULE][DB] RULE_FETCHED",D=function lt(){this.type=O},P={status:"pristine",data:[]};function k(t,e){switch(void 0===t&&(t=P),e.type){case A:return S({},t,{status:"dirty"});case O:return S({},t,{status:"pending"});case $:return S({},t,{data:e.payload,status:"succeed"});case F:return S({},t,{status:"failed"});case T:var n=t.data.concat();return-1<(r=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[r]=Object.assign({},n[r],e.payload):n.push(e.payload),S({},t,{data:n});case B:var r;n=t.data.concat();return-1<(r=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[r]=Object.assign({},n[r],e.payload):n.push(e.payload),S({},t,{data:n});default:return t}}var U="[GWT][SCENARIO][DB][LIST] SCENARIOS_LIST",N="[SCENARIO][DB] SCENARIOS_LIST_START",q="[SCENARIO][DB] SCENARIOS_LIST_SUCCEED",G="[SCENARIO][DB] SCENARIOS_LIST_FAILED",H="[GWT][SCENARIO][DB][UPSERT] SCENARIO_UPSERT",V="[SCENARIO][DB] SCENARIO_FETCHED",W="[GWT][SCENARIO][DB] UPDATE_DB",z=function mt(){this.type=N},J=function yt(t){this.payload=t,this.type=H},K=function vt(t){this.payload=t,this.type=V},Q={status:"pristine",data:[]};function X(n,e){switch(void 0===n&&(n=Q),e.type){case U:return S({},n,{status:"dirty"});case N:return S({},n,{status:"pending"});case q:return S({},n,{data:e.payload,status:"succeed"});case G:return S({},n,{status:"failed"});case H:var t=n.data.concat();return-1<(r=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[r]=Object.assign({},t[r],e.payload):t.push(e.payload),S({},n,{data:t});case V:var r;t=n.data.concat();return-1<(r=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[r]=Object.assign({},t[r],e.payload):t.push(e.payload),S({},n,{data:t});case W:var o=n.data.concat();return e.payload.forEach(function(e){var t=n.data.findIndex(function(t){return t._id==e._id});-1<t?o[t]=Object.assign({},o[t],e):o.push(e)}),S({},n,{data:o});default:return n}}var Y={ruleAnchors:M,rules:k,scenarios:X},Z=function(){function t(t,e,n){var r=this;this.store=e,this.injector=n,this.config$=new c.BehaviorSubject(v),t.steps=t.stepClasses.map(function(t){return new t(r.injector)}),this._config=Object.assign({},v,t),this.config$.next(this._config)}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),t.decorators=[{type:l.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:l.Inject,args:[g]}]},{type:y.Store},{type:l.Injector}]},t}(),tt=function(){function t(t){var e=void 0===t?{}:t,n=e._id,r=e.anchorId,o=e.steps,i=e.name,a=e.featureId;this._id=n||"",this.name=i||"",this.featureId=a||"",this._id=n||"",this.anchorId=r||"",this.steps=o||[]}return t.prototype.getRequsetBody=function(){return{_id:this._id,anchorId:this.anchorId,name:this.name,featureId:this.featureId,steps:this.steps.map(function(t){return{id:t.id,opposite:t.opposite,params:t.params}})}},t}(),et=function(){function t(t,e){this.resolver=t,this.container=e}return Object.defineProperty(t.prototype,"params",{get:function(){return this.component.instance.params||{}},enumerable:!0,configurable:!0}),t.prototype.ngOnChanges=function(){this.component},t.prototype.ngOnInit=function(){if(!this.step.stepComponent)throw new Error("Trying to use an unsupported type ().\n\t\t  Supported types: ");var t=this.resolver.resolveComponentFactory(this.step.stepComponent);this.component=this.container.createComponent(t),this.component.instance.params=this.step.params},t.decorators=[{type:l.Directive,args:[{selector:"[rule-step-loader]"}]}],t.ctorParameters=function(){return[{type:l.ComponentFactoryResolver},{type:l.ViewContainerRef}]},t.propDecorators={step:[{type:l.Input}],component:[{type:l.ViewChild,args:["container",{read:l.ViewContainerRef}]}]},t}(),nt=function(){function t(t,e,n){var r=this;this.http=t,this.store=e,this.configService=n,this.scenarios={},this.config$=this.configService.config$,this.config$.subscribe(function(t){return r.config=t})}return t.prototype.upsert=function(t){var e=new tt(t);return this.http.post(this.config.env.frontend_server+this.config.endpoints.upsert,e.getRequsetBody()).pipe(d.map(function(t){return t}),d.share())},t.prototype.getAnchorScenarios=function(e){var n=this;return this.scenarios[e]||(this.scenarios[e]=new u.BehaviorSubject([]),this.http.get(this.config.env.frontend_server+p.stringTemplate(this.config.endpoints.get,{anchorId:e})).pipe(d.map(function(t){return t.Result})).subscribe(function(t){return n.scenarios[e].next(t)})),this.scenarios[e]},t.prototype.selectScenarioById=function(e){var n=new u.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(d.filter(function(t){return null!=t}),d.map(function(t){return t.find(function(t){return t._id==e})}),d.filter(function(t){return t!=undefined})).subscribe(function(t){n.next(t)}),n.asObservable()},t.prototype.selectAnchorScenarios=function(e){var n=new u.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(d.startWith([]),d.filter(function(t){return null!=t}),d.map(function(t){return t.filter(function(t){return t._id==e})})).subscribe(function(t){n.next(t)}),n.asObservable()},t.decorators=[{type:l.Injectable}],t.ctorParameters=function(){return[{type:m.HttpClient},{type:y.Store},{type:Z}]},t}(),rt=function(){function t(t,e,n,r,o){this.store=t,this.configService=e,this.scenarioService=n,this.injector=r,this.data=o,this.unsubscribe=new s.Subject,this.scenario$=new s.BehaviorSubject(new tt),this.scenarios$=new s.BehaviorSubject([]),this._create_scenario_form_group(),this._init_features_list()}return t.prototype.ngOnInit=function(){var e=this;this.steps$=this.configService.config$.pipe(d.map(function(t){return t.steps}),d.takeUntil(this.unsubscribe)),this.steps$.subscribe(function(t){return e.steps=t}),this._load_scenario_and_map_scenario_step_to_steps_class(),this.scenario$.subscribe(function(t){})},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype.save=function(){var t=this.scenario$.getValue();this.stepLoaders.forEach(function(e){t.steps.find(function(t){return t.name===e.step.name}).params=e.params}),t.featureId=this.scenarioFormGroup.value.featureId,t.name=this.scenarioFormGroup.value.name,this.store.dispatch(new J(t))},t.prototype.addStepToScenario=function(t){var e=this.scenario$.getValue();e.steps.push(t),this.scenario$.next(e)},t.prototype.deleteStepFromScenario=function(e){var t=this.scenario$.getValue();t.steps.splice(t.steps.findIndex(function(t){return t.name===e.name}),1),this.scenario$.next(t)},t.prototype.decScenarioStepPriority=function(t){},t.prototype.incScenarioStepPriority=function(t){},t.prototype.addNewScenario=function(){var t=this.scenarios$.getValue();t.push(new tt({anchorId:this.data.anchorId})),this.scenarios$.next(t)},t.prototype.activeScenario=function(t){var r=this;t.steps=t.steps.map(function(e){var t=r.steps.find(function(t){return t.id===e.id}),n=Object.create(t);return n.params=e.params,n}),this.scenarioFormGroup.patchValue(t),t.anchorId=this.data.anchorId,this.scenario$.next(t)},t.prototype._load_scenario_and_map_scenario_step_to_steps_class=function(){var e=this;this.scenarioService.getAnchorScenarios(this.data.anchorId).pipe(d.takeUntil(this.unsubscribe)).subscribe(function(t){e.scenarios$.next(t),e.activeScenario(t[0]||new tt)})},t.prototype._create_scenario_form_group=function(){this.scenarioFormGroup=new a.FormGroup({featureId:new a.FormControl,name:new a.FormControl})},t.prototype._reset_scenario_form_group_and_patch_with_active_scenario=function(){this.scenarioFormGroup.reset(),this.scenarioFormGroup.patchValue(this.scenario$.getValue())},t.prototype._init_features_list=function(){this.features$=["مدیریت نمایش براساس دسترسی های کاربر"]},t.decorators=[{type:l.Component,args:[{selector:"app-gwt-view",template:'<div fxLayout="row" fxLayoutGap="25px">\r\n  <div fxFlex="400px" fxLayout="column" fxLayoutGap="15px">\r\n    \x3c!-- <div fxLayout="row wrap">\r\n    <mat-form-field appearance="fill" fxFlex="100">\r\n      <input matInput placeholder="فیلتر">\r\n      <mat-icon matSuffix>search</mat-icon>\r\n    </mat-form-field>\r\n    <mat-checkbox fxFlex class="example-margin">فرض کنید</mat-checkbox>\r\n    <mat-checkbox fxFlex class="example-margin">هنگامی که</mat-checkbox>\r\n    <mat-checkbox fxFlex class="example-margin">آنگاه</mat-checkbox>\r\n  </div> --\x3e\r\n    <mat-card class="steps-item" *ngFor="let step of steps$ | async">\r\n      <span class="step-text">\r\n        {{step.description}}\r\n      </span>\r\n      <button mat-icon-button class="add-button" (click)="addStepToScenario(step)">\r\n        <mat-icon>arrow_back_ios</mat-icon>\r\n      </button>\r\n    </mat-card>\r\n  </div>\r\n\r\n  <div fxFlex="700px">\r\n    <div fxLayout="row wrap" fxLayoutGap="25px" fxLayoutAlign="center center" class="scenario-toolbar">\r\n      <div fxFlex>\r\n        <mat-form-field class="fit">\r\n          <mat-select placeholder="وِیژگی" (selectionChange)="activeScenario($event.value)">\r\n            <mat-option *ngFor="let scenario of scenarios$ | async" [value]="scenario">\r\n              {{ scenario.featureId }} : {{ scenario.name }}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <button fxFlex="nogrow" mat-raised-button color="primary" (click)="addNewScenario()">\r\n        ثبت سناریو جدید\r\n      </button>\r\n    </div>\r\n    <div fxLayout="column" fxLayoutGap="15px">\r\n      <div fxFlex="100" fxLayout="row" fxLayoutGap="25px" [formGroup]="scenarioFormGroup">\r\n        <mat-form-field fxFlex="50">\r\n          <mat-select placeholder="ویژگی" formControlName="featureId">\r\n            <mat-option *ngFor="let feature of features$" [value]="feature">\r\n              {{ feature }}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n        <mat-form-field fxFlex="50">\r\n          <input matInput placeholder="نام" formControlName="name">\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor="let step of (scenario$ | async).steps">\r\n        <div class="scenario-steps-item">\r\n          <ng-container rule-step-loader [step]="step"></ng-container>\r\n          <div class="scenario-steps-action">\r\n            <button mat-icon-button (click)="deleteStepFromScenario(step)">\r\n              <mat-icon>delete</mat-icon>\r\n            </button>\r\n            <button mat-icon-button (click)="incScenarioStepPriority(step)">\r\n              <mat-icon>keyboard_arrow_up</mat-icon>\r\n            </button>\r\n            <button mat-icon-button (click)="decScenarioStepPriority(step)">\r\n              <mat-icon>keyboard_arrow_down</mat-icon>\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </ng-container>\r\n      <button fxFlex="nogrow" mat-raised-button color="primary" (click)="save()">\r\n        ثبت\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>',styles:[":host{width:100vw}.scenario-toolbar{height:60px;margin-bottom:20px}"]}]}],t.ctorParameters=function(){return[{type:y.Store},{type:Z},{type:nt},{type:l.Injector},{type:undefined,decorators:[{type:l.Inject,args:[i.MAT_BOTTOM_SHEET_DATA]}]}]},t.propDecorators={stepLoaders:[{type:l.ViewChildren,args:[et]}]},t}(),ot={Given:"Given",When:"When",Then:"Then",And:"And",But:"But"},it=function(){function t(t,e,n,r,o,i){var a=this;this.scenarioService=t,this.configService=e,this.store=n,this.el=r,this.renderer=o,this.bottomSheet=i,this.unsubscribe=new s.Subject,this.active$=this.store.select(function(t){return t.rule.ruleAnchors.active}).pipe(d.takeUntil(this.unsubscribe)),this.active$.subscribe(function(t){return a.active=t}),this.el.nativeElement.classList.add("ngs-rule-anchor"),this.steps=this.configService.config$.getValue().steps}return t.prototype.onMouseEnter=function(){this.el,this.active&&this.showAnchor()},t.prototype.onMouseLeave=function(){var t=this;this.active&&setTimeout(function(){t.hideAnchor()},999)},t.prototype.showAnchor=function(){this.el.nativeElement.classList.add("show-anchor")},t.prototype.hideAnchor=function(){this.el.nativeElement.classList.remove("show-anchor")},t.prototype.ngOnInit=function(){var r=this;this.anchorScenarios$=this.scenarioService.getAnchorScenarios(this.anchorId).pipe(d.takeUntil(this.unsubscribe),d.filter(function(t){return t!==undefined})),this.active$.subscribe(function(t){t?r._activate_anchor():r._deactivate_anchor()}),this.anchorScenarios$.subscribe(function(t){t.forEach(function(t){t.steps=t.steps.map(function(e){var t=r.steps.find(function(t){return t.id===e.id}),n=Object.create(t);return n.params=e.params,n}),r._do_scenario(t)})})},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype._activate_anchor=function(){this._create_anchor(),this._set_active_class_to_host()},t.prototype._deactivate_anchor=function(){this._remove_anchor(),this._remove_active_class_to_host()},t.prototype._set_active_class_to_host=function(){this.el.nativeElement.classList.add("anchor-active")},t.prototype._remove_active_class_to_host=function(){this.el.nativeElement.classList.remove("anchor-active")},t.prototype._create_anchor=function(){var e=this;this.button=this.renderer.createElement("button"),this.button.classList.add("ngs-rule-anchor-button","mat-icon-button"),this.button.setAttribute("mat-icon-button",""),this.button.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),e.bottomSheet.open(rt,{data:{anchorId:e.anchorId},panelClass:"magenta-theme"})});var t=this.renderer.createElement("mat-icon");t.classList.add("mat-icon","material-icons");var n=this.renderer.createText("settings");this.renderer.appendChild(t,n),this.renderer.appendChild(this.button,t),this.renderer.appendChild(this.el.nativeElement,this.button)},t.prototype._remove_anchor=function(){this.button&&this.button.parentNode.removeChild(this.button)},t.prototype._do_scenario=function(t){var n=this,r=t,e=r.steps.filter(function(t){return t.type===ot.Given}).map(function(t){return t.interperator(t.params)});s.combineLatest(e).pipe(d.takeUntil(this.unsubscribe),d.map(function(t){return t.every(function(t){return!0===t})}),d.switchMap(function(t){if(t){var e=r.steps.filter(function(t){return t.type===ot.Then}).map(function(t){return t.interperator(t.params,n.el)});return s.combineLatest.apply(null,e).pipe(d.map(function(t){return t.every(function(t){return!0===t})}))}return s.of(!1)})).subscribe(function(){})},t.decorators=[{type:l.Directive,args:[{selector:"[ruleAnchor]"}]}],t.ctorParameters=function(){return[{type:nt},{type:Z},{type:y.Store},{type:l.ElementRef},{type:l.Renderer2},{type:i.MatBottomSheet}]},t.propDecorators={anchorId:[{type:l.Input,args:["ruleAnchor"]}],onMouseEnter:[{type:l.HostListener,args:["mouseenter"]}],onMouseLeave:[{type:l.HostListener,args:["mouseleave"]}]},t}(),at=function(){function t(t,e){var n=this;this.actions$=t,this.service=e,this.EditProfileRequest$=this.actions$.pipe(f.ofType(U),d.map(function(){return new z})),this.UpsertScenario$=this.actions$.pipe(f.ofType(H),d.map(function(t){return t.payload}),d.switchMap(function(t){return n.service.upsert(t)}),d.map(function(t){return new K(t)}))}return t.decorators=[{type:l.Injectable}],t.ctorParameters=function(){return[{type:f.Actions},{type:nt}]},I([f.Effect(),w("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),I([f.Effect(),w("design:type",Object)],t.prototype,"UpsertScenario$",void 0),t}(),st=function(){function t(t){this.actions$=t,this.EditProfileRequest$=this.actions$.pipe(f.ofType(A),d.map(function(){return new D}))}return t.decorators=[{type:l.Injectable}],t.ctorParameters=function(){return[{type:f.Actions}]},I([f.Effect(),w("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),t}(),ct=function(){function t(t){this.store=t,this.anchorsMode=!1,this.havePermission$=this.store.select(h.getFrontendAuthenticationState)}return t.prototype.toggleAnchors=function(){!1===this.anchorsMode?(this.store.dispatch(new L),this.anchorsMode=!0):(this.store.dispatch(new j),this.anchorsMode=!1)},t.decorators=[{type:l.Component,args:[{selector:"gwt-mode-button",template:'    <button *ngIf="!(havePermission$ | async)" class="btn" mat-mini-fab type="button" routerLink="auth/frontend/signin" fxFlex="nogrow" fxLayoutAlign="center center">\n      <mat-icon>fingerprint</mat-icon>\n    </button>\n\n    <button *ngIf="havePermission$ | async" class="btn" mat-mini-fab type="button" (click)="toggleAnchors()" fxFlex="nogrow" fxLayoutAlign="center center">\n      <mat-icon>settings</mat-icon>\n    </button>',styles:[".btn{position:fixed;bottom:25px;left:25px;z-index:3}"]}]}],t.ctorParameters=function(){return[{type:y.Store}]},t}(),ut=function(){function t(t,e,n){this.http=t,this.store=e,this.configurationService=n}return t.decorators=[{type:l.Injectable}],t.ctorParameters=function(){return[{type:m.HttpClient},{type:y.Store},{type:Z}]},t}(),pt=function(){function t(){}return t.forRoot=function(t){return{ngModule:ft,providers:[{provide:g,useValue:t||{}},ut,Z,nt]}},t.decorators=[{type:l.NgModule,args:[{imports:[m.HttpClientModule,a.FormsModule,o.RouterModule,e.CommonModule,i.MatExpansionModule,i.MatSnackBarModule,i.MatIconModule,i.MatButtonModule,i.MatCardModule,i.MatCheckboxModule,i.MatTableModule,i.MatSelectModule,i.MatInputModule,i.MatFormFieldModule,i.MatTabsModule,i.MatDividerModule,n.FlexLayoutModule,i.MatRadioModule,i.MatSlideToggleModule,a.ReactiveFormsModule,r.BrowserAnimationsModule],declarations:[b,it,rt,et,ct],entryComponents:[rt],exports:[it,ct]}]}],t}(),ft=function(){function t(){}return t.decorators=[{type:l.NgModule,args:[{imports:[pt,y.StoreModule.forFeature("rule",Y),f.EffectsModule.forFeature([st,at]),x],exports:[pt]}]}],t}();t.RuleModule=pt,t.GwtStepTypes=ot,t.ShowAnchorsAction=L,t.HideAnchorsAction=j,t.ɵp=st,t.ɵn=k,t.ɵq=at,t.ɵo=X,t.ɵj=rt,t.ɵl=ct,t.ɵd=it,t.ɵm=M,t.ɵr=x,t.ɵc=b,t.ɵb=g,t.ɵa=ft,t.ɵg=Y,t.ɵi=Z,t.ɵs=ut,t.ɵe=nt,t.ɵk=et,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=soushians-rule.umd.min.js.map