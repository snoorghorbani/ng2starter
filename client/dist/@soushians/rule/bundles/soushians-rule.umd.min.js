!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("@ngrx/store"),require("rxjs/BehaviorSubject"),require("@angular/common/http"),require("rxjs/Rx"),require("rxjs/operators"),require("rxjs"),require("@angular/material"),require("@angular/forms"),require("@ngrx/effects"),require("@angular/common"),require("@angular/flex-layout"),require("@angular/platform-browser/animations")):"function"==typeof define&&define.amd?define("@soushians/rule",["exports","@angular/core","@angular/router","@ngrx/store","rxjs/BehaviorSubject","@angular/common/http","rxjs/Rx","rxjs/operators","rxjs","@angular/material","@angular/forms","@ngrx/effects","@angular/common","@angular/flex-layout","@angular/platform-browser/animations"],e):e((t.soushians=t.soushians||{},t.soushians.rule={}),t.ng.core,t.ng.router,null,t.rxjs.BehaviorSubject,t.ng.common.http,t.rxjs.Rx,t.rxjs.operators,t.rxjs,t.ng.material,t.ng.forms,null,t.ng.common,t.ng["flex-layout"],t.ng.platformBrowser.animations)}(this,function(t,e,n,r,o,i,a,s,c,u,p,l,d,f,h){"use strict";var m={endpoints:{},stepClasses:[]},y=new e.InjectionToken("RuleModuleConfig"),v=function(){function t(){}return t.prototype.ngOnInit=function(){},t.decorators=[{type:e.Component,args:[{selector:"app-rule",template:'<div fxLayout="row" fxLayoutAlign="center center">\n  <router-outlet></router-outlet>\n</div>'}]}],t.ctorParameters=function(){return[]},t}(),g=[{path:"rule",component:v}],b=n.RouterModule.forChild(g),_=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t};function x(t,e,n,r){var o,i=arguments.length,a=i<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;0<=s;s--)(o=t[s])&&(a=(i<3?o(a):3<i?o(e,n,a):o(e,n))||a);return 3<i&&a&&Object.defineProperty(e,n,a),a}function S(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}var I="[RULE][ANCHORS] SHOW_ANCHORS",E="[RULE][ANCHORS] HIDE_ANCHORS",w=function(){this.type=I},R=function(){this.type=E},j={active:!1};function C(t,e){switch(void 0===t&&(t=j),e.type){case I:return _({},t,{active:!0});case E:return _({},t,{active:!1});default:return t}}var M=function(){function t(t,e,n){var r=this;this.store=e,this.injector=n,this.config$=new o.BehaviorSubject(m),t.steps=t.stepClasses.map(function(t){return new t(r.injector)}),this._config=Object.assign({},m,t),this.config$.next(this._config)}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:e.Inject,args:[y]}]},{type:r.Store},{type:e.Injector}]},t}(),L=function(){function t(t,e,n){this.http=t,this.store=e,this.configurationService=n}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:i.HttpClient},{type:r.Store},{type:M}]},t}(),A=function(){function t(t){var e=void 0===t?{}:t,n=e._id,r=e.anchorId,o=e.steps,i=e.name,a=e.featureId;this._id=n||"",this.name=i||"",this.featureId=a||"",this._id=n||"",this.anchorId=r||"",this.steps=o||[]}return t.prototype.getRequsetBody=function(){return{_id:this._id,anchorId:this.anchorId,name:this.name,featureId:this.featureId,steps:this.steps.map(function(t){return{id:t.id,opposite:t.opposite,params:t.params}})}},t}(),O="[GWT][SCENARIO][DB][LIST] SCENARIOS_LIST",F="[SCENARIO][DB] SCENARIOS_LIST_START",T="[SCENARIO][DB] SCENARIOS_LIST_SUCCEED",$="[SCENARIO][DB] SCENARIOS_LIST_FAILED",D="[GWT][SCENARIO][DB][UPSERT] SCENARIO_UPSERT",B="[SCENARIO][DB] SCENARIO_FETCHED",U="[GWT][SCENARIO][DB] UPDATE_DB",P=function(){this.type=F},k=function(t){this.payload=t,this.type=D},N=function(t){this.payload=t,this.type=B},G=function(){function t(t,e){this.resolver=t,this.container=e}return Object.defineProperty(t.prototype,"params",{get:function(){return this.component.instance.params||{}},enumerable:!0,configurable:!0}),t.prototype.ngOnChanges=function(){this.component},t.prototype.ngOnInit=function(){if(!this.step.stepComponent)throw new Error("Trying to use an unsupported type ().\n\t\t  Supported types: ");var t=this.resolver.resolveComponentFactory(this.step.stepComponent);this.component=this.container.createComponent(t),this.component.instance.params=this.step.params},t.decorators=[{type:e.Directive,args:[{selector:"[rule-step-loader]"}]}],t.ctorParameters=function(){return[{type:e.ComponentFactoryResolver},{type:e.ViewContainerRef}]},t.propDecorators={step:[{type:e.Input}],component:[{type:e.ViewChild,args:["container",{read:e.ViewContainerRef}]}]},t}(),q=function(){function t(t,e,n){this.http=t,this.store=e,this.configurationService=n}return t.prototype.upsert=function(t){var e=new A(t);return this.http.post("http://localhost:3000/api/gwt/scenario",e.getRequsetBody()).pipe(s.map(function(t){return t}),s.share())},t.prototype.getAnchorScenarios=function(t){return this.http.get("http://localhost:3000/api/gwt/anchor/"+t+"/scenarios").map(function(t){return t.Result})},t.prototype.selectScenarioById=function(e){var n=new a.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(s.filter(function(t){return null!=t}),s.map(function(t){return t.find(function(t){return t._id==e})}),s.filter(function(t){return t!=undefined})).subscribe(function(t){n.next(t)}),n.asObservable()},t.prototype.selectAnchorScenarios=function(e){var n=new a.BehaviorSubject(undefined);return this.store.select(function(t){return t.rule.scenarios.data}).pipe(s.startWith([]),s.filter(function(t){return null!=t}),s.map(function(t){return t.filter(function(t){return t._id==e})})).subscribe(function(t){n.next(t)}),n.asObservable()},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ctorParameters=function(){return[{type:i.HttpClient},{type:r.Store},{type:M}]},t.ngInjectableDef=e.defineInjectable({factory:function(){return new t(e.inject(i.HttpClient),e.inject(r.Store),e.inject(M))},token:t,providedIn:"root"}),t}(),H=function(){function t(t,e,n,r,o){this.store=t,this.configService=e,this.scenarioService=n,this.injector=r,this.data=o,this.unsubscribe=new c.Subject,this.scenario$=new c.BehaviorSubject(new A),this.scenarios$=new c.BehaviorSubject([]),this._create_scenario_form_group(),this._init_features_list()}return t.prototype.ngOnInit=function(){var e=this;this.steps$=this.configService.config$.pipe(s.map(function(t){return t.steps}),s.takeUntil(this.unsubscribe)),this.steps$.subscribe(function(t){return e.steps=t}),this._load_scenario_and_map_scenario_step_to_steps_class()},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype.save=function(){var t=this.scenario$.getValue();this.stepLoaders.forEach(function(e){t.steps.find(function(t){return t.name==e.step.name}).params=e.params}),t.featureId=this.scenarioFormGroup.value.featureId,t.name=this.scenarioFormGroup.value.name,this.store.dispatch(new k(t))},t.prototype.addStepToScenario=function(t){var e=this.scenario$.getValue();e.steps.push(t),this.scenario$.next(e)},t.prototype.deleteStepFromScenario=function(e){var t=this.scenario$.getValue();t.steps.splice(t.steps.findIndex(function(t){return t.name==e.name}),1),this.scenario$.next(t)},t.prototype.decScenarioStepPriority=function(t){},t.prototype.incScenarioStepPriority=function(t){},t.prototype.addNewScenario=function(){var t=this.scenarios$.getValue();t.push(new A({anchorId:this.data.anchorId})),this.scenarios$.next(t)},t.prototype.activeScenario=function(t){var n=this;t.steps=t.steps.map(function(e){var t=n.steps.find(function(t){return t.id==e.id});return t.params=e.params,t}),this.scenarioFormGroup.patchValue(t),t.anchorId=this.data.anchorId,this.scenario$.next(t)},t.prototype._load_scenario_and_map_scenario_step_to_steps_class=function(){var e=this;this.scenarioService.getAnchorScenarios(this.data.anchorId).pipe(s.takeUntil(this.unsubscribe)).subscribe(function(t){e.scenarios$.next(t),e.activeScenario(t[0]||new A)})},t.prototype._create_scenario_form_group=function(){this.scenarioFormGroup=new p.FormGroup({featureId:new p.FormControl,name:new p.FormControl})},t.prototype._reset_scenario_form_group_and_patch_with_active_scenario=function(){this.scenarioFormGroup.reset(),this.scenarioFormGroup.patchValue(this.scenario$.getValue())},t.prototype._init_features_list=function(){this.features$=["مدیریت نمایش براساس دسترسی های کاربر"]},t.decorators=[{type:e.Component,args:[{selector:"app-gwt-view",template:'<div fxLayout="row" fxLayoutGap="25px">\n<div fxFlex="400px" fxLayout="column" fxLayoutGap="15px">\n  <div fxLayout="row wrap">\n    <mat-form-field appearance="fill" fxFlex="100">\n      <input matInput placeholder="فیلتر">\n      <mat-icon matSuffix>search</mat-icon>\n    </mat-form-field>\n    <mat-checkbox fxFlex class="example-margin">فرض کنید</mat-checkbox>\n    <mat-checkbox fxFlex class="example-margin">هنگامی که</mat-checkbox>\n    <mat-checkbox fxFlex class="example-margin">آنگاه</mat-checkbox>\n  </div>\n    <mat-card class="steps-item" *ngFor="let step of steps$ | async">\n      <span class="step-text">\n        {{step.description}}\n      </span>\n      <button mat-icon-button class="add-button" (click)="addStepToScenario(step)">\n        <mat-icon>arrow_back_ios</mat-icon>\n      </button>\n    </mat-card>\n</div>\n\n<div fxFlex="700px">\n  <div fxLayout="row wrap" fxLayoutGap="25px" fxLayoutAlign="center center" class="scenario-toolbar">\n    <div fxFlex>\n        <mat-form-field class="fit">\n            <mat-select placeholder="وِیژگی" (selectionChange)="activeScenario($event.value)">\n                  <mat-option *ngFor="let scenario of scenarios$ | async" [value]="scenario">\n                {{ scenario.featureId }} : {{ scenario.name }}\n              </mat-option>\n            </mat-select>\n          </mat-form-field>\n    </div>\n    <button fxFlex="nogrow" mat-raised-button color="primary" (click)="addNewScenario()">\n       ثبت سناریو جدید\n    </button>\n  </div>\n  <div fxLayout="column" fxLayoutGap="15px">\n    <div fxFlex="100" fxLayout="row" fxLayoutGap="25px" [formGroup]="scenarioFormGroup">\n      <mat-form-field fxFlex="50">\n        <mat-select placeholder="ویژگی" formControlName="featureId">\n          <mat-option *ngFor="let feature of features$" [value]="feature">\n            {{ feature }}\n          </mat-option>\n        </mat-select>\n      </mat-form-field>\n      <mat-form-field fxFlex="50">\n        <input matInput placeholder="نام" formControlName="name">\n      </mat-form-field>\n    </div>\n    <ng-container *ngFor="let step of (scenario$ | async).steps">\n      <div class="scenario-steps-item">\n        <ng-container rule-step-loader [step]="step"></ng-container>\n        <div class="scenario-steps-action">\n          <button mat-icon-button (click)="deleteStepFromScenario(step)">\n            <mat-icon>delete</mat-icon>\n          </button>\n          <button mat-icon-button (click)="incScenarioStepPriority(step)">\n            <mat-icon>keyboard_arrow_up</mat-icon>\n          </button>\n          <button mat-icon-button (click)="decScenarioStepPriority(step)">\n            <mat-icon>keyboard_arrow_down</mat-icon>\n          </button>\n        </div>\n      </div>\n    </ng-container>\n      <button fxFlex="nogrow" mat-raised-button color="primary" (click)="save()">\n        ثبت\n      </button>\n    </div>\n  </div>\n</div>',styles:[":host{width:100vw}.scenario-toolbar{height:60px;margin-bottom:20px}"]}]}],t.ctorParameters=function(){return[{type:r.Store},{type:M},{type:q},{type:e.Injector},{type:undefined,decorators:[{type:e.Inject,args:[u.MAT_BOTTOM_SHEET_DATA]}]}]},t.propDecorators={stepLoaders:[{type:e.ViewChildren,args:[G]}]},t}(),V={Given:"Given",When:"When",Then:"Then",And:"And",But:"But"},W=function(){function t(t,e,n,r,o,i){var a=this;this.scenarioService=t,this.configService=e,this.store=n,this.el=r,this.renderer=o,this.bottomSheet=i,this.unsubscribe=new c.Subject,this.active$=this.store.select(function(t){return t.rule.ruleAnchors.active}).pipe(s.takeUntil(this.unsubscribe)),this.active$.subscribe(function(t){return a.active=t}),this.el.nativeElement.classList.add("ngs-rule-anchor"),this.steps=this.configService.config$.getValue().steps}return t.prototype.onMouseEnter=function(){this.active&&this.showAnchor()},t.prototype.onMouseLeave=function(){this.active&&this.hideAnchor()},t.prototype.showAnchor=function(){this.el.nativeElement.classList.add("show-anchor")},t.prototype.hideAnchor=function(){this.el.nativeElement.classList.remove("show-anchor")},t.prototype.ngOnInit=function(){var n=this;this.anchorScenarios$=this.scenarioService.getAnchorScenarios(this.anchorId).pipe(s.takeUntil(this.unsubscribe),s.filter(function(t){return t!=undefined})),this.active$.subscribe(function(t){t?n._activate_anchor():n._deactivate_anchor()}),this.anchorScenarios$.subscribe(function(t){t.forEach(function(t){t.steps=t.steps.map(function(e){var t=n.steps.find(function(t){return t.id==e.id});return t.params=e.params,t}),n._do_scenario(t)})})},t.prototype.ngOnDestroy=function(){this.unsubscribe.next(),this.unsubscribe.complete()},t.prototype._activate_anchor=function(){this._create_anchor(),this._set_active_class_to_host()},t.prototype._deactivate_anchor=function(){this._remove_anchor(),this._remove_active_class_to_host()},t.prototype._set_active_class_to_host=function(){this.el.nativeElement.classList.add("anchor-active")},t.prototype._remove_active_class_to_host=function(){this.el.nativeElement.classList.remove("anchor-active")},t.prototype._create_anchor=function(){var e=this;this.button=this.renderer.createElement("button"),this.button.classList.add("ngs-rule-anchor-button","mat-icon-button"),this.button.setAttribute("mat-icon-button",""),this.button.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),e.bottomSheet.open(H,{data:{anchorId:e.anchorId},panelClass:"magenta-theme"})});var t=this.renderer.createElement("mat-icon");t.classList.add("mat-icon","material-icons");var n=this.renderer.createText("settings");this.renderer.appendChild(t,n),this.renderer.appendChild(this.button,t),this.renderer.appendChild(this.el.nativeElement,this.button)},t.prototype._remove_anchor=function(){this.button&&this.button.parentNode.removeChild(this.button)},t.prototype._do_scenario=function(n){var r=this,t=n.steps.filter(function(t){return t.type==V.Given}).map(function(t){return t.interperator(t.params)});c.zip.apply(null,t).pipe(s.takeUntil(this.unsubscribe),s.map(function(t){return t.every(function(t){return!0===t})}),s.switchMap(function(t){if(t){var e=n.steps.filter(function(t){return t.type==V.Then}).map(function(t){return t.interperator(t.params,r.el)});return c.zip.apply(null,e).pipe(s.map(function(t){return t.every(function(t){return!0===t})}))}c.of(!1)})).subscribe(function(){})},t.decorators=[{type:e.Directive,args:[{selector:"[ruleAnchor]"}]}],t.ctorParameters=function(){return[{type:q},{type:M},{type:r.Store},{type:e.ElementRef},{type:e.Renderer2},{type:u.MatBottomSheet}]},t.propDecorators={anchorId:[{type:e.Input,args:["ruleAnchor"]}],onMouseEnter:[{type:e.HostListener,args:["mouseenter"]}],onMouseLeave:[{type:e.HostListener,args:["mouseleave"]}]},t}(),z="[RULE][DB] RULES_LIST",K="[RULE][DB] RULES_LIST_START",J="[RULE][DB] RULES_LIST_SUCCEED",Q="[RULE][DB] RULES_LIST_FAILED",X="[RULE][DB] RULE_UPSERT",Y="[RULE][DB] RULE_FETCHED",Z=function(){this.type=K},tt={status:"pristine",data:[]};function et(t,e){switch(void 0===t&&(t=tt),e.type){case z:return _({},t,{status:"dirty"});case K:return _({},t,{status:"pending"});case J:return _({},t,{data:e.payload,status:"succeed"});case Q:return _({},t,{status:"failed"});case X:var n=t.data.concat();return-1<(r=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[r]=Object.assign({},n[r],e.payload):n.push(e.payload),_({},t,{data:n});case Y:var r;n=t.data.concat();return-1<(r=t.data.findIndex(function(t){return t._id==e.payload._id}))?n[r]=Object.assign({},n[r],e.payload):n.push(e.payload),_({},t,{data:n});default:return t}}var nt={status:"pristine",data:[]};function rt(n,e){switch(void 0===n&&(n=nt),e.type){case O:return _({},n,{status:"dirty"});case F:return _({},n,{status:"pending"});case T:return _({},n,{data:e.payload,status:"succeed"});case $:return _({},n,{status:"failed"});case D:var t=n.data.concat();return-1<(r=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[r]=Object.assign({},t[r],e.payload):t.push(e.payload),_({},n,{data:t});case B:var r;t=n.data.concat();return-1<(r=n.data.findIndex(function(t){return t._id==e.payload._id}))?t[r]=Object.assign({},t[r],e.payload):t.push(e.payload),_({},n,{data:t});case U:var o=n.data.concat();return e.payload.forEach(function(e){var t=n.data.findIndex(function(t){return t._id==e._id});-1<t?o[t]=Object.assign({},o[t],e):o.push(e)}),_({},n,{data:o});default:return n}}var ot={ruleAnchors:C,rules:et,scenarios:rt},it=function(){function t(t,e){var n=this;this.actions$=t,this.service=e,this.EditProfileRequest$=this.actions$.ofType(O).pipe(s.map(function(){return new P})),this.UpsertScenario$=this.actions$.ofType(D).pipe(s.map(function(t){return t.payload}),s.switchMap(function(t){return n.service.upsert(t)}),s.map(function(t){return new N(t)}))}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:l.Actions},{type:q}]},x([l.Effect(),S("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),x([l.Effect(),S("design:type",Object)],t.prototype,"UpsertScenario$",void 0),t}(),at=function(){function t(t){this.actions$=t,this.EditProfileRequest$=this.actions$.ofType(z).map(function(){return new Z})}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:l.Actions}]},x([l.Effect(),S("design:type",Object)],t.prototype,"EditProfileRequest$",void 0),t}(),st=function(){function t(t){this.store=t,this.anchorsMode=!1}return t.prototype.toggleAnchors=function(){!1===this.anchorsMode?(this.store.dispatch(new w),this.anchorsMode=!0):(this.store.dispatch(new R),this.anchorsMode=!1)},t.decorators=[{type:e.Component,args:[{selector:"gwt-mode-button",template:'\n    <button class="btn" mat-fab type="button" (click)="toggleAnchors()" fxFlex="nogrow" fxLayoutAlign="center center">\n      <mat-icon>settings</mat-icon>\n    </button>',styles:[".btn{position:fixed;bottom:25px;right:25px;z-index:3}"]}]}],t.ctorParameters=function(){return[{type:r.Store}]},t}(),ct=function(){function t(){}return t.forRoot=function(t){return{ngModule:ut,providers:[{provide:y,useValue:t||{}},L,M]}},t.decorators=[{type:e.NgModule,args:[{imports:[i.HttpClientModule,p.FormsModule,n.RouterModule,d.CommonModule,u.MatExpansionModule,u.MatSnackBarModule,u.MatIconModule,u.MatButtonModule,u.MatCardModule,u.MatCheckboxModule,u.MatTableModule,u.MatSelectModule,u.MatInputModule,u.MatFormFieldModule,u.MatTabsModule,u.MatDividerModule,f.FlexLayoutModule,u.MatRadioModule,u.MatSlideToggleModule,p.ReactiveFormsModule,h.BrowserAnimationsModule],declarations:[v,W,H,G,st],entryComponents:[H],exports:[W,st]}]}],t}(),ut=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[ct,r.StoreModule.forFeature("rule",ot),l.EffectsModule.forFeature([at,it]),b],exports:[ct]}]}],t}();t.GwtStepTypes=V,t.ShowAnchorsAction=w,t.HideAnchorsAction=R,t.RuleModule=ct,t.RootRuleModule=ut,t.MODULE_DEFAULT_CONFIG=m,t.MODULE_CONFIG_TOKEN=y,t.ɵo=at,t.ɵm=et,t.ɵp=it,t.ɵn=rt,t.ɵi=H,t.ɵk=st,t.ɵl=C,t.ɵb=W,t.ɵq=b,t.ɵa=v,t.ɵe=ot,t.ɵh=M,t.ɵr=L,t.ɵg=M,t.ɵc=q,t.ɵj=G,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=soushians-rule.umd.min.js.map