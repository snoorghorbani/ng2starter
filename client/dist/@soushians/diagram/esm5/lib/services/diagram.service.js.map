{
  "version": 3,
  "file": "diagram.service.js",
  "sources": [
    "ng://@soushians/diagram/projects/soushians/diagram/src/lib/services/diagram.service.ts"
  ],
  "sourcesContent": [
    "import { Injectable } from \"@angular/core\";\r\nimport { HttpClient } from \"@angular/common/http\";\r\nimport { Observable, Subscription } from \"rxjs/Rx\";\r\nimport { Store } from \"@ngrx/store\";\r\ndeclare var c3: any;\r\n\r\nimport { AddDiagramApiModel, GetDiagramsApiModel, DiagramModel, SourceModel } from \"../models\";\r\nimport { DiagramConfigurationService } from \"./diagram-configuration.service\";\r\nimport { FeatureState } from \"../reducers\";\r\n\r\ndeclare var _: any;\r\n\r\n@Injectable({\r\n\tprovidedIn: \"root\"\r\n})\r\nexport class DiagramService {\r\n\tconstructor(\r\n\t\tprivate http: HttpClient,\r\n\t\tprivate store: Store<FeatureState>,\r\n\t\tprivate userConfigurationService: DiagramConfigurationService\r\n\t) {}\r\n\r\n\tgetDiagrams(): Observable<GetDiagramsApiModel.Response> {\r\n\t\treturn this.http\r\n\t\t\t.get<GetDiagramsApiModel.Response>(\"http://localhost:3000/api/diagram\")\r\n\t\t\t.map(response => response)\r\n\t\t\t.catch(err => {\r\n\t\t\t\treturn Observable.throw(err);\r\n\t\t\t});\r\n\t}\r\n\tgetSources(): Observable<SourceModel[]> {\r\n\t\treturn this.http\r\n\t\t\t.get(\"http://localhost:3000/api/source\")\r\n\t\t\t.map(response => (response as any).Result)\r\n\t\t\t.catch(err => {\r\n\t\t\t\treturn Observable.throw(err);\r\n\t\t\t});\r\n\t}\r\n\tgetGroups(): Observable<string[]> {\r\n\t\treturn this.http\r\n\t\t\t.get(\"http://localhost:3000/api/diagram/groups\")\r\n\t\t\t.map(response => (response as any).Result)\r\n\t\t\t.catch(err => {\r\n\t\t\t\treturn Observable.throw(err);\r\n\t\t\t});\r\n\t}\r\n\tgetDiagram(id: string): Observable<any> {\r\n\t\tdebugger;\r\n\t\tif (!id) debugger;\r\n\t\treturn this.http.get(`http://localhost:3000/api/diagram/${id}`).map(response => response).catch(err => {\r\n\t\t\treturn Observable.throw(err);\r\n\t\t});\r\n\t}\r\n\taddDiagram(data: any): Observable<AddDiagramApiModel.Response> {\r\n\t\tvar model = new AddDiagramApiModel.Request(data);\r\n\t\tdebugger;\r\n\t\treturn this.http\r\n\t\t\t.post<AddDiagramApiModel.Response>(\"http://localhost:3000/api/diagram\", model.getRequestBody())\r\n\t\t\t.map(response => response)\r\n\t\t\t.catch(err => {\r\n\t\t\t\treturn Observable.throw(err);\r\n\t\t\t});\r\n\t}\r\n\tupdateDiagram(body: any): Observable<any> {\r\n\t\tdebugger;\r\n\t\treturn this.http.put(\"http://localhost:3000/api/diagram\", body).map(response => response).catch(err => {\r\n\t\t\treturn Observable.throw(err);\r\n\t\t});\r\n\t}\r\n\tdeleteDiagram(id: string): Observable<any> {\r\n\t\treturn this.http.delete(`http://localhost:3000/api/diagram/${id}`).map(response => response).catch(err => {\r\n\t\t\treturn Observable.throw(err);\r\n\t\t});\r\n\t}\r\n\tgetData(source: SourceModel, time: number = 0, once: Boolean = false): Observable<any> {\r\n\t\tif (once && time !== 0) {\r\n\t\t\treturn this.http\r\n\t\t\t\t.get(`http://localhost:3000/api/data`, {\r\n\t\t\t\t\tparams: {\r\n\t\t\t\t\t\tsourceId: source._id,\r\n\t\t\t\t\t\ttime: this.getFloorTime(source.Interval, time).toString()\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.map((res: any) => res.Result);\r\n\t\t} else if (source.Interval == 0) {\r\n\t\t\treturn this.http\r\n\t\t\t\t.get(`http://localhost:3000/api/data`, {\r\n\t\t\t\t\tparams: {\r\n\t\t\t\t\t\tsourceId: source._id,\r\n\t\t\t\t\t\ttime: null\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\t.map((res: any) => res.Result);\r\n\t\t} else {\r\n\t\t\ttime = time || Date.now();\r\n\t\t\treturn Observable.timer(0, source.Interval).switchMap(i =>\r\n\t\t\t\tthis.http\r\n\t\t\t\t\t.get(`http://localhost:3000/api/data`, {\r\n\t\t\t\t\t\tparams: {\r\n\t\t\t\t\t\t\tsourceId: source._id,\r\n\t\t\t\t\t\t\ttime: this.getFloorTime(source.Interval, time).toString()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t\t.map((res: any) => res.Result)\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\textract_columns_from_data(data: any, columnsMappings) {\r\n\t\tlet res = [];\r\n\r\n\t\tcolumnsMappings.forEach(item => {\r\n\t\t\tvar ValueData = _.getValue(data, item.ValuePath);\r\n\r\n\t\t\tif (!item.NamePath) {\r\n\t\t\t\treturn res.push([ item.ValuePath.split(\".\").pop() ].concat(ValueData));\r\n\t\t\t}\r\n\t\t\tvar NameData = _.getValue(data, item.NamePath);\r\n\r\n\t\t\tif (_.is.array(NameData)) {\r\n\t\t\t\treturn (res = res.concat(NameData.map((item, i) => [ item ].concat(ValueData[i]))));\r\n\t\t\t} else {\r\n\t\t\t\treturn res.push([ NameData ].concat(ValueData));\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn res;\r\n\t}\r\n\tget_data_report(data: any) {\r\n\t\treturn _.report(data);\r\n\t}\r\n\tget_last_node_of_data(data: any) {\r\n\t\treturn (_.report(data) as any[]).filter(item => item.isLastNode);\r\n\t}\r\n\tbuildChartConfig(columns) {\r\n\t\treturn {\r\n\t\t\tdata: {\r\n\t\t\t\tcolumns\r\n\t\t\t},\r\n\t\t\tlegend: {\r\n\t\t\t\tshow: true\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\t// TODO: implement interface of c3 config\r\n\tcharts = {};\r\n\tgenerateDiagram(config: any, id: string, route: string, sync: number): Subscription {\r\n\t\tthis.charts[id] = c3.generate({\r\n\t\t\t...config,\r\n\t\t\tbindto: `#diagram_${id}`\r\n\t\t});\r\n\r\n\t\treturn this.getData({} as SourceModel, sync).subscribe(data => {\r\n\t\t\tthis.charts[id].load({\r\n\t\t\t\tcolumns: this.extract_columns_from_data(data.Data, config.ColumnMappings)\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tgetFloorTime(precision = 60 * 1000, time: number = 0) {\r\n\t\treturn Math.floor((time || Date.now()) / precision);\r\n\t}\r\n}\r\n"
  ],
  "names": [],
  "mappings": "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"
}
